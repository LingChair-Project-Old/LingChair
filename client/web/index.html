<!doctype html>
<html lang="zh-CN" class="mdui-theme-auto">

<!--
 * ©2024 The LingChair Project
 * 
 * Make a more colorful world...
 * 
 * License - Apache License 2.0
 * Author - @MoonLeeeaf <https://github.com/MoonLeeeaf>
 * Organization - @LingChair <https://github.com/LingChair>
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" />
    <meta name="renderer" content="webkit" />

    <!-- 字体 -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <!-- UI库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@2/mdui.css">
    <script src="https://cdn.jsdelivr.net/npm/mdui@2/mdui.global.js"></script>

    <!-- 工具库 -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.js"></script>
    <title>铃之椅</title>
</head>

<body style="display: flex;">
    <!-- 侧边导航栏 -->
    <mdui-navigation-rail alignment="center" class="侧边导航栏">
        <mdui-button-icon icon="menu" slot="top"></mdui-button-icon>

        <mdui-navigation-rail-item icon="watch_later--outlined" active-icon="watch_later" alt="最近" show=".list_最近">
        </mdui-navigation-rail-item>
        <mdui-navigation-rail-item icon="contacts--outlined" active-icon="contacts" alt="联系人" show=".list_联系人">
        </mdui-navigation-rail-item>
        <mdui-navigation-rail-item icon="favorite_border" active-icon="favorite" alt="关注" show=".list_关注">
        </mdui-navigation-rail-item>

        <mdui-button-icon icon="settings" slot="bottom"></mdui-button-icon>

        <script>
            $(`.侧边列表 > mdui-list`).hide()

            $('.侧边导航栏').click(function (event) {
                const v = event.target
                if (v.tagName.toLowerCase() == 'mdui-navigation-rail-item') {
                    $(`.侧边列表 > mdui-list`).hide()
                    $($(v).attr('show')).show()
                }
            })

            $(() => $('mdui-navigation-rail-item[show=".list_最近"]').click())
        </script>
    </mdui-navigation-rail>

    <div
        style="position: relative; overflow: hidden; width:100%; height: calc(var(--lc-height) - 16px); display: flex;">
        <!-- 侧边栏 -->
        <div class="侧边列表" style="width:22%;">
            <!-- 最近 -->
            <mdui-list class="list_最近">
                <mdui-list-subheader>最近</mdui-list-subheader>

                <mdui-list-item rounded alignment="center" description="这是一个测试" user-id="">
                    满月娘娘
                    <mdui-avatar slot="icon" src="https://avatars.githubusercontent.com/u/150461955?v=4"></mdui-avatar>
                </mdui-list-item>
                <mdui-list-item rounded alignment="center" description="这还是一个测试" user-id="">
                    满月叶
                    <mdui-avatar slot="icon" src="https://avatars.githubusercontent.com/u/150461955?v=4"></mdui-avatar>
                </mdui-list-item>

            </mdui-list>
            <style>
                .侧边列表>*>mdui-list-item {
                    margin: 5px;
                }
            </style>
            <script>

                $('.list_最近').click(function (event) {
                    let v = event.target
                    for (let i = 0; i < 3; i++) {
                        if (v.tagName.toLowerCase() == 'mdui-list-item') {
                            $('.list_最近 > mdui-list-item').attr('active', null)
                            v.active = true
                            ChatContainer.switchTo($(v).attr('user-id'), v.innerText)
                            break
                        }
                        v = v.parentNode
                    }
                })
            </script>

            <!-- 联系人 -->
            <mdui-list class="list_联系人">
                <mdui-list-subheader>好友</mdui-list-subheader>
            </mdui-list>
            <script>
                $('.list_联系人').click(function (event) {
                    let v = event.target
                    for (let i = 0; i < 3; i++) {
                        if (v.tagName.toLowerCase() == 'mdui-list-item') {
                            $('.list_联系人 > mdui-list-item').attr('active', null)
                            v.active = true
                            break
                        }
                        v = v.parentNode
                    }
                })
            </script>

            <!-- 关注 -->
            <mdui-list class="list_关注">
                <mdui-list-subheader>关注</mdui-list-subheader>
            </mdui-list>
            <script>
                $('.list_关注').click(function (event) {
                    let v = event.target
                    for (let i = 0; i < 3; i++) {
                        if (v.tagName.toLowerCase() == 'mdui-list-item') {
                            $('.list_关注 > mdui-list-item').attr('active', null)
                            v.active = true
                            break
                        }
                        v = v.parentNode
                    }
                })
            </script>

        </div>

        <!-- 聊天页面框架 -->
        <div style="height: 100%; width: 78%;">

            <div>
                <mdui-top-app-bar class="聊天显示框架_工具栏" scroll-target=".聊天显示框架">
                    <mdui-top-app-bar-title style="font-size: calc(var(--mdui-typescale-title-medium-size) + 4px);">
                    </mdui-top-app-bar-title>

                    <div style="flex-grow: 1"></div>

                    <mdui-button-icon icon="call"></mdui-button-icon>
                    <mdui-button-icon icon="more_vert"></mdui-button-icon>
                </mdui-top-app-bar>

                <div class="聊天显示框架" style="height: 90%;"></div>

                <!-- 消息编辑 - 更多 -->
                <mdui-dropdown placement="bottom" class="消息编辑_更多选项">
                    <mdui-menu style="margin-top: calc(var(--lc-height) - 150%);">
                        <mdui-menu-item>
                            插入图片
                            <mdui-icon slot="icon" name="image"></mdui-icon>
                        </mdui-menu-item>
                        <mdui-menu-item>
                            插入文件
                            <mdui-icon slot="icon" name="attach_file"></mdui-icon>
                        </mdui-menu-item>
                        <mdui-menu-item>
                            插入语音
                            <mdui-icon slot="icon" name="keyboard_voice"></mdui-icon>
                        </mdui-menu-item>
                    </mdui-menu>
                </mdui-dropdown>

                <mdui-text-field class="消息编辑框" autosize placeholder="(｡･ω･｡)" style="position: absolute; bottom: 0;">
                    <mdui-button-icon class="更多选项" slot="icon" icon="more_vert"></mdui-button-icon>
                    <mdui-button-icon slot="end-icon" icon="send"></mdui-button-icon>
                </mdui-text-field>

                <script>
                    $('.更多选项').click(() => $('.消息编辑_更多选项').attr('open', true))
                    $('.聊天显示框架').parent().hide()

                    class ChatContainer {
                        /**
                         * 转到某人的聊天页面
                         * @param { String } id 用户ID/群ID
                         * @param { String } nick 用户昵称/群名称
                         */
                        static switchTo(id, nick) {
                            $('.无聊天页面').hide()
                            $('.聊天显示框架').parent().show()

                            $('.聊天显示框架_工具栏 > mdui-top-app-bar-title').text(nick)
                        }
                    }
                </script>
            </div>

            <div class="无聊天页面" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
                <div style="align-self: center; display: flex; flex-direction: column; align-items: center;">
                    <span style="font-size: calc(var(--mdui-typescale-title-medium-size) + 2px);">选择一个联系人以开始对话</span>
                </div>
            </div>

        </div>
    </div>

    <!-- 等待对话框 -->
    <mdui-dialog class="waiting-dialog">
        <mdui-circular-progress style="margin-left: 3px"></mdui-circular-progress>
        <span style="margin-left: 20px; position: absolute; bottom: 38%;">稍等片刻...</span>
        <style>
            .waiting-dialog {
                z-index: 114514;
            }

            .waiting-dialog::part(body) {
                overflow: hidden;
                margin-top: 2px;
                margin-left: 2px;
            }
        </style>
    </mdui-dialog>

    <!-- 初次使用对话框 -->
    <mdui-dialog headline="欢迎!" description="铃之椅 是一个轻量、跨平台、简单易用且开源的即时通讯项目, 目前仍处于试验阶段. 欢迎浏览我们的主页: https://lingchair.github.io/introduce" class="example-action">
        <mdui-button slot="action" variant="text">关闭</mdui-button>
    </mdui-dialog>
    <script>

    </script>

    <!-- 连接到服务对话框 -->
    <mdui-dialog headline="连接到服务" description="铃之椅 是去中心化的, 你需要一个已有的服务来使用它, 且不同服务间数据并不相通. 如需了解更多, 请参考 https://github.com/LingChair/LingChair" class="example-action">
        <mdui-text-field label="节点命名" value="default"></mdui-text-field>
        <div style="height: 10px;"></div>
        <mdui-text-field label="服务地址"></mdui-text-field>
        <mdui-button slot="action" variant="text">保存并连接</mdui-button>
    </mdui-dialog>
    <script>
        
    </script>

    <!-- 安全的数据储存 -->
    <script>
        let dataIsEmpty = !localStorage.lingchair_data || localStorage.lingchair_data == ''

        const aes = {
            enc: (m, k) => CryptoJS.AES.encrypt(m, k).toString(),
            dec: (m, k) => CryptoJS.AES.decrypt(m, k).toString(CryptoJS.enc.Utf8),
        }

        let key = location.href + '_LingChair_满月姐姐'

        if (dataIsEmpty) localStorage.lingchair_data = aes.enc('{}', key)

        let _dec = aes.dec(localStorage.lingchair_data, key)
        if(_dec == '') _dec = '{}'

        const _data_cached = JSON.parse(_dec)
        const data = new Proxy({}, {
            get: (obj, k) => {
                return _data_cached[k]
            },
            set: (obj, k, v) => {
                _data_cached[k] = v
                localStorage.lingchair_data = aes.enc(JSON.stringify(_data_cached), key)
            },
        })
    </script>

    <!-- 事件注册 -->
    <script>
        window.onresize = function () {
            document.body.style.setProperty('--lc-width', `${window.innerWidth}px`)
            document.body.style.setProperty('--lc-height', `${window.innerHeight}px`)

            $('.消息编辑框').get(0).style.width = window.innerWidth - ($('.侧边导航栏').width() + $('.侧边列表').width()) - 40 + 'px'
            $('.聊天显示框架_工具栏').get(0).style.marginLeft = $('.侧边导航栏').width() + $('.侧边列表').width() - 40 + 'px'
        }
        $(() => window.onresize())
    </script>

</body>

</html>